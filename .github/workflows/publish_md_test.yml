name: Publish output MD to GitHub Pages

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Run daily arxiv"] # è¿™ä¸ªå·¥ä½œæµä¼šåœ¨Run daily arxivå®Œæˆåè¢«è§¦å‘ï¼ŒRun daily arxivåˆæ˜¯æ¯å¤©å®šæ—¶è§¦å‘ï¼Œä»è€Œè®©è¿™ä¸ªå®šæ—¶è§¦å‘
    types:
      - completed

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç 
      - uses: actions/checkout@v4

      # ä¸‹è½½ç”Ÿæˆçš„ Artifact
      - name: Download artifact
        id: download-artifact
        uses: dawidd6/action-download-artifact@v4
        with:
          workflow: cron_runs.yaml
          workflow_conclusion: success
          name: arxiv-scanner-outputs


      # æ£€æŸ¥ output.md å’Œ output_translated.md æ˜¯å¦å­˜åœ¨
      - name: Check for output files
        id: check_files
        uses: andstor/file-existence-action@v2
        with:
          files: output.md,output_translated.md

      # ç¡®ä¿è¾“å‡ºç›®å½•å’Œè¯­è¨€å­ç›®å½•å­˜åœ¨
      - name: Ensure dist directories exist
        run: |
          mkdir -p dist/en
          mkdir -p dist/zh

      # è½¬æ¢è‹±æ–‡ç‰ˆæœ¬çš„ output.md ä¸ºç½‘é¡µ
      - name: Convert English version to pages
        uses: wranders/markdown-to-pages-action@v0.1
        if: steps.check_files.outputs.files_exists == 'true'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          file: output.md
          out-path: dist/en
          out-path-not-empty: true

      # è½¬æ¢ä¸­æ–‡ç‰ˆæœ¬çš„ output_translated.md ä¸ºç½‘é¡µ
      - name: Convert Chinese version to pages
        uses: wranders/markdown-to-pages-action@v0.1
        if: steps.check_files.outputs.files_exists == 'true'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          file: output_translated.md
          out-path: dist/zh
          out-path-not-empty: true

      - name: Generate navigation index
        run: |
          current_date=$(TZ="Asia/Shanghai" date "+%Y-%m-%d %H:%M:%S")
          
          echo "<!DOCTYPE html>" > dist/index.html
          echo "<html lang=\"en\">" >> dist/index.html
          echo "<head>" >> dist/index.html
          echo "    <meta charset=\"UTF-8\">" >> dist/index.html
          echo "    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">" >> dist/index.html
          echo "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">" >> dist/index.html
          echo "    <title>GPT Paper Assistant</title>" >> dist/index.html
          echo "</head>" >> dist/index.html
          echo "<body>" >> dist/index.html
          echo "    <h1>GPT Paper Assistant</h1>" >> dist/index.html
          echo "    <p>Update Date and Time: $current_date</p>" >> dist/index.html

          echo "    <p>Welcome to the Arxiv Paper Assistant! Please select a language:</p>" >> dist/index.html
          echo "    <ul>" >> dist/index.html
          echo "        <li><a href=\"./en\">English Version</a></li>" >> dist/index.html
          echo "        <li><a href=\"./zh\">ä¸­æ–‡ç‰ˆæœ¬</a></li>" >> dist/index.html
          echo "    </ul>" >> dist/index.html
          echo "    <footer>" >> dist/index.html
          echo "        <small>&copy; 2025 GPT Paper Assistant. All rights reserved.</small>" >> dist/index.html
          echo "    </footer>" >> dist/index.html
          echo "</body>" >> dist/index.html
          echo "</html>" >> dist/index.html

      - name: Debug deployment condition
        run: |
          echo "Deployment condition: ${{ steps.check_files.outputs.files_exists }}"

      # ä¸Šä¼ é™æ€ç½‘é¡µæ–‡ä»¶ä½œä¸º GitHub Pages çš„ artifact
      - name: Upload Pages artifact
        uses: actions/upload-artifact@v4
        if: steps.check_files.outputs.files_exists == 'true'
        with:
          path: dist

      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: dist # The folder the action should deploy.

      - name: Set environment variables
        run: |
          echo "FROM_ADDR=${{ secrets.FROM_ADDR }}" >> $GITHUB_ENV
          echo "TO_ADDR=${{ secrets.TO_ADDR }}" >> $GITHUB_ENV
          echo "PASSWORD=${{ secrets.PASSWORD }}" >> $GITHUB_ENV

      # Step 5: Sent email
      - name: sent .html to email
        run: |
          python sent_email.py